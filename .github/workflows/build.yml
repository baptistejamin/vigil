on:
  push:
    tags:
      - "v*.*.*"

name: Build and Release

jobs:
  build-docker:
    strategy:
      matrix:
        include:
          - runner: ubuntu-22.04
            platforms: linux/amd64
          - runner: ubuntu-22.04-arm
            platforms: linux/arm64,linux/arm/v7

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Acquire Docker image metadata
        id: metadata
        uses: docker/metadata-action@v4
        with:
          images: baptistejamin/vigil

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract base tag and create platform tags
        id: tags
        run: |
          BASE_TAG=$(echo "${{ steps.metadata.outputs.tags }}" | head -n1 | sed 's/.*://')
          PLATFORMS="${{ matrix.platforms }}"
          
          TAGS=""
          if [[ "$PLATFORMS" == *"amd64"* ]]; then
            TAGS="${TAGS}baptistejamin/vigil:${BASE_TAG}-amd64"$'\n'
          fi
          if [[ "$PLATFORMS" == *"arm64"* ]]; then
            TAGS="${TAGS}baptistejamin/vigil:${BASE_TAG}-arm64"$'\n'
          fi
          if [[ "$PLATFORMS" == *"arm/v7"* ]]; then
            TAGS="${TAGS}baptistejamin/vigil:${BASE_TAG}-armv7"$'\n'
          fi
          
          echo "base_tag=$BASE_TAG" >> $GITHUB_OUTPUT
          {
            echo 'tags<<EOF'
            echo -n "$TAGS"
            echo EOF
          } >> $GITHUB_OUTPUT
          echo "Tags to push:"
          echo "$TAGS"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platforms }}
          tags: ${{ steps.tags.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  create-manifest:
    needs: build-docker
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Acquire Docker image metadata
        id: metadata
        uses: docker/metadata-action@v4
        with:
          images: baptistejamin/vigil

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract base tag
        id: tag
        run: |
          TAG=$(echo "${{ steps.metadata.outputs.tags }}" | head -n1 | sed 's/.*://')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Base tag: $TAG"

      - name: Create and push multi-arch manifest
        run: |
          BASE_TAG="${{ steps.tag.outputs.tag }}"
          docker buildx imagetools create \
            --tag baptistejamin/vigil:${BASE_TAG} \
            baptistejamin/vigil:${BASE_TAG}-amd64 \
            baptistejamin/vigil:${BASE_TAG}-arm64 \
            baptistejamin/vigil:${BASE_TAG}-armv7
